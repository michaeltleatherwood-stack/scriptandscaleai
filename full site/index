// ScriptAndScale AI Chat-Only Web App - Simplified JSON Handling
// Version: 2026-01-10
// Any valid JSON POST with a "message" field is treated as chat request
// No "action" field required

function doPost(e) {
  // Only accept POST requests with body
  if (!e || !e.postData || !e.postData.contents) {
    return ContentService
      .createTextOutput(JSON.stringify({ response: "Invalid request - no data received" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  let data;
  try {
    data = JSON.parse(e.postData.contents);
  } catch (err) {
    return ContentService
      .createTextOutput(JSON.stringify({ response: "Invalid JSON format" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // If there's a message field (string, non-empty after trim), treat as chat
  const message = (data.message || '').trim();

  if (!message) {
    return ContentService
      .createTextOutput(JSON.stringify({ response: "Please provide a message" }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // Optional sessionId (kept for consistency with frontend)
  const sessionId = data.sessionId || 'unknown';

  // Get OpenAI API key from Script Properties
  const openaiApiKey = PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY');
  
  if (!openaiApiKey) {
    Logger.log("Missing OPENAI_API_KEY in Script Properties");
    return ContentService
      .createTextOutput(JSON.stringify({ response: "Service configuration error. Please try again later." }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // Prepare OpenAI request payload
  const payload = {
    model: "gpt-4o-mini",
    messages: [
      {
        role: "system",
        content: "You are ScriptAndScale AI Assistant. Be helpful, concise, professional, and promote our AI agents naturally when relevant."
      },
      {
        role: "user",
        content: message
      }
    ],
    temperature: 0.7,
    max_tokens: 300
  };

  const options = {
    method: "post",
    contentType: "application/json",
    headers: {
      "Authorization": "Bearer " + openaiApiKey
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    const response = UrlFetchApp.fetch("https://api.openai.com/v1/chat/completions", options);
    const json = JSON.parse(response.getContentText());

    if (json.choices && json.choices.length > 0) {
      const botReply = json.choices[0].message.content.trim();
      return ContentService
        .createTextOutput(JSON.stringify({ response: botReply }))
        .setMimeType(ContentService.MimeType.JSON);
    } else {
      return ContentService
        .createTextOutput(JSON.stringify({ response: "Sorry, couldn't get a response. Try again." }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (err) {
    Logger.log("OpenAI error: " + err);
    return ContentService
      .createTextOutput(JSON.stringify({ response: "Sorry, something went wrong. Please try again in a moment." }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

// Optional: minimal doGet to prevent confusion when visiting URL directly
function doGet() {
  return ContentService
    .createTextOutput(JSON.stringify({ message: "This endpoint only accepts POST requests with JSON containing a 'message' field." }))
    .setMimeType(ContentService.MimeType.JSON);
}
