// ScriptAndScale AI Backend v3.5.0 - January 10, 2026
// • Proper JSON parsing for chat (Content-Type: application/json)
// • Skips IPN validation when action === "chat"
// • doGet kept for legacy/fallback, but chat now primarily via doPost JSON
// • PayPal IPN handling unchanged

const LOG_SPREADSHEET_NAME = 'ScriptAndScale Orders Log';
const LOG_SHEET_NAME = 'Log';
const QUEUE_SHEET_NAME = 'Delivery Queue';
const PROPERTY_KEY = 'LOG_SPREADSHEET_ID';

function doGet(e) {
  // Legacy/fallback support (query string parameters)
  return handleRequest(e.parameter, null);
}

function doPost(e) {
  // Determine content type and parse accordingly
  let contentType = e.postData ? e.postData.type : '';
  let data = {};

  if (contentType === 'application/json') {
    // Chat widget JSON payload
    try {
      data = JSON.parse(e.postData.contents);
    } catch (err) {
      return ContentService
        .createTextOutput(JSON.stringify({ response: 'Invalid JSON format' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } else {
    // PayPal IPN (application/x-www-form-urlencoded) or legacy
    data = e.parameter || {};
  }

  return handleRequest(data, e);
}

function handleRequest(data, e) {
  const action = data.action || '';

  if (action === 'chat') {
    return handleChat(data);
  } 
  else {
    // Everything else → treat as PayPal IPN (or invalid)
    if (e && e.postData && e.postData.contents) {
      return handleIPN(e);
    } else {
      return ContentService
        .createTextOutput(JSON.stringify({ error: 'Invalid or unsupported request' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }
}

function handleChat(data) {
  const message = data.message || '';
  const sessionId = data.sessionId || 'unknown';

  if (!message.trim()) {
    return ContentService
      .createTextOutput(JSON.stringify({ response: 'Please provide a message.' }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const openaiApiKey = PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY');
  if (!openaiApiKey) {
    return ContentService
      .createTextOutput(JSON.stringify({ response: 'Service configuration error. Please try again later.' }))
      .setMimeType(ContentService.MimeType.JSON);
  }

  const payload = {
    model: "gpt-4o-mini",
    messages: [
      { 
        role: "system", 
        content: "You are ScriptAndScale AI Assistant. Be helpful, concise, professional, and promote our AI agents naturally when relevant." 
      },
      { role: "user", content: message }
    ],
    temperature: 0.7,
    max_tokens: 300
  };

  const options = {
    method: "post",
    contentType: "application/json",
    headers: {
      "Authorization": "Bearer " + openaiApiKey
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    const response = UrlFetchApp.fetch("https://api.openai.com/v1/chat/completions", options);
    const json = JSON.parse(response.getContentText());

    if (json.choices && json.choices.length > 0) {
      const botReply = json.choices[0].message.content.trim();
      return ContentService
        .createTextOutput(JSON.stringify({ response: botReply }))
        .setMimeType(ContentService.MimeType.JSON);
    } else {
      return ContentService
        .createTextOutput(JSON.stringify({ response: "Sorry, couldn't get a response. Try again." }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  } catch (err) {
    Logger.log('OpenAI error: ' + err);
    return ContentService
      .createTextOutput(JSON.stringify({ response: "Sorry, something went wrong. Please try again in a moment." }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function handleIPN(e) {
  // ────────────────────────────────────────────────────────────────
  // Everything below this line is unchanged from previous version
  // ────────────────────────────────────────────────────────────────

  var rawData = e.postData.contents;
  var params = e.parameter || {};

  // Dynamic verification URL
  var verifyUrl = 'https://ipnpb.paypal.com/cgi-bin/webscr';
  if (params.test_ipn === '1') {
    verifyUrl = 'https://ipnpb.sandbox.paypal.com/cgi-bin/webscr';
  }

  // Payload integrity fix
  var cmd = 'cmd=_notify-validate';
  var payload = cmd + '&' + rawData;

  var options = {
    method: 'post',
    payload: payload,
    contentType: 'application/x-www-form-urlencoded',
    muteHttpExceptions: true
  };

  var response = UrlFetchApp.fetch(verifyUrl, options);
  var responseText = response.getContentText().trim();
  var verified = (responseText === 'VERIFIED');

  // Parse fields
  var txn_id = params.txn_id || 'TEST-' + new Date().getTime();
  var payer_email = params.payer_email || 'testbuyer@example.com';
  var custom = params.custom || '';
  var mc_gross = parseFloat(params.mc_gross || '0.00');

  // Complexity check
  var readyAgents = ['Social Content Generator', 'Chat Bot'];
  var isComplex = (readyAgents.indexOf(custom) === -1);

  // Open log spreadsheet from Script Properties (auto-create first time)
  var logSpreadsheet = getLogSpreadsheet();
  var logSheet = logSpreadsheet.getSheetByName(LOG_SHEET_NAME) || logSpreadsheet.insertSheet(LOG_SHEET_NAME);
  logSheet.appendRow([new Date(), verified ? 'VERIFIED' : 'UNVERIFIED (' + responseText + ')', rawData, txn_id, custom, payer_email, mc_gross, isComplex ? 'complex' : 'simple']);

  // Queue regardless
  var queueSheet = logSpreadsheet.getSheetByName(QUEUE_SHEET_NAME) || logSpreadsheet.insertSheet(QUEUE_SHEET_NAME);
  if (queueSheet.getLastRow() === 0) {
    queueSheet.appendRow(['Queued Time', 'Txn ID', 'Agent', 'Payer Email', 'Amount', 'Status', 'Delivered Time', 'Verified']);
  }
  queueSheet.appendRow([new Date(), txn_id, custom, payer_email, mc_gross, 'queued', '', verified ? 'yes' : 'no']);

  return ContentService.createTextOutput('Received and queued');
}

function getLogSpreadsheet() {
  var properties = PropertiesService.getScriptProperties();
  var ssId = properties.getProperty(PROPERTY_KEY);
  if (ssId) {
    return SpreadsheetApp.openById(ssId);
  }
  var ss = SpreadsheetApp.create(LOG_SPREADSHEET_NAME);
  properties.setProperty(PROPERTY_KEY, ss.getId());
  return ss;
}

function processDeliveryBatch() {
  var logSpreadsheet = getLogSpreadsheet();
  var queueSheet = logSpreadsheet.getSheetByName(QUEUE_SHEET_NAME);
  if (!queueSheet || queueSheet.getLastRow() <= 1) return;

  var data = queueSheet.getDataRange().getValues();
  var rows = data.slice(1);

  var now = new Date();
  var day = now.getDay();
  if (day === 0 || day === 6) return;

  var processed = 0;

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    if (row[5] !== 'queued') continue;

    var queuedTime = new Date(row[0]);
    var hoursSince = (now - queuedTime) / 3600000;
    if (hoursSince < 24) continue;

    var agent = row[2];
    var payer_email = row[3];

    var htmlBody = buildCustomizedEmailHtml(agent);
    var zipBlob = buildCustomizedAgentZip(agent);

    MailApp.sendEmail(payer_email, 'Your ScriptAndScale AI Agent: ' + agent, 'Full package attached.', {
      htmlBody: htmlBody,
      attachments: [zipBlob]
    });

    queueSheet.getRange(i + 2, 6).setValue('delivered');
    queueSheet.getRange(i + 2, 7).setValue(now);

    processed++;

    MailApp.sendEmail('michaeltleatherwood@gmail.com', 'Agent Delivered (Verified: ' + row[7] + ')',
      'Agent: ' + agent + '\nTo: ' + payer_email + '\nTxn: ' + row[1]);
  }

  if (processed > 0) {
    MailApp.sendEmail('michaeltleatherwood@gmail.com', 'Batch Complete', processed + ' agents delivered.');
  }
}

function buildCustomizedEmailHtml(agent) {
  return '<h1>Your ' + agent + ' is ready!</h1><p>Instructions...</p>';
}

function buildCustomizedAgentZip(agent) {
  var files = [];
  files.push(Utilities.newBlob('// ' + agent + ' code', 'text/plain', 'main.gs'));
  return Utilities.zip(files, agent + '.zip');
}
